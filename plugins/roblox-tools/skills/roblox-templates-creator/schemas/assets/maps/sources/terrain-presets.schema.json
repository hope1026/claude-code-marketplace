{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "terrain-preset.schema.json",
  "title": "Terrain Preset Schema",
  "description": "Schema for MCP-generated terrain presets with randomization support",
  "type": "object",
  "required": ["name", "theme", "difficulty", "description", "bounds", "generation", "spawnConfig", "focusView"],

  "properties": {
    "name": {
      "type": "string",
      "description": "Display name in English",
      "minLength": 1,
      "maxLength": 50
    },
    "nameKo": {
      "type": "string",
      "description": "Display name in Korean (optional)",
      "maxLength": 50
    },
    "theme": {
      "type": "string",
      "description": "Terrain theme category",
      "enum": ["mountain", "plains", "desert", "island", "snow", "volcanic", "forest", "flat"]
    },
    "difficulty": {
      "type": "string",
      "description": "Complexity level",
      "enum": ["beginner", "intermediate", "advanced"]
    },
    "description": {
      "type": "string",
      "description": "Brief description in English",
      "minLength": 10,
      "maxLength": 200
    },
    "size": {
      "$ref": "#/$defs/sizeConfig"
    },
    "bounds": {
      "$ref": "#/$defs/bounds"
    },
    "generation": {
      "$ref": "#/$defs/generationConfig"
    },
    "spawnConfig": {
      "$ref": "#/$defs/spawnConfig"
    },
    "objectSpawnConfig": {
      "$ref": "#/$defs/objectSpawnConfig"
    },
    "focusView": {
      "$ref": "#/$defs/terrainFocusView"
    },
    "postProcess": {
      "type": "array",
      "items": { "$ref": "#/$defs/postProcessStep" }
    },
    "customization": {
      "$ref": "#/$defs/customization"
    },
    "variants": {
      "type": "object",
      "description": "Named variant configurations",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "description": { "type": "string" },
          "materialOverrides": { "type": "object" }
        }
      }
    }
  },

  "$defs": {
    "vector3": {
      "type": "object",
      "required": ["x", "y", "z"],
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" },
        "z": { "type": "number" }
      },
      "additionalProperties": false
    },

    "bounds": {
      "type": "object",
      "description": "Bounding box coordinates (studs)",
      "required": ["min", "max"],
      "properties": {
        "min": { "$ref": "#/$defs/vector3" },
        "max": { "$ref": "#/$defs/vector3" }
      },
      "additionalProperties": false
    },

    "varianceValue": {
      "type": "object",
      "required": ["base", "variance"],
      "properties": {
        "base": { "type": "number", "description": "Base value" },
        "variance": { "type": "number", "description": "Random variance range (Â±)", "minimum": 0 }
      },
      "additionalProperties": false
    },

    "materialLayer": {
      "type": "object",
      "required": ["material", "maxHeight"],
      "properties": {
        "material": {
          "type": "string",
          "description": "Roblox terrain material",
          "enum": [
            "Air", "Water",
            "Grass", "LeafyGrass", "Ground", "Mud", "Sand", "Sandstone",
            "Rock", "Slate", "Basalt", "Limestone",
            "Snow", "Glacier", "Ice",
            "CrackedLava", "Neon",
            "Concrete", "Pavement", "Brick", "Cobblestone"
          ]
        },
        "maxHeight": {
          "type": "number",
          "description": "Maximum height for this material layer (studs)"
        }
      },
      "additionalProperties": false
    },

    "sizeConfig": {
      "type": "object",
      "required": ["base", "variants"],
      "properties": {
        "base": { "type": "integer", "description": "Default terrain size", "minimum": 64 },
        "variants": {
          "type": "array",
          "items": { "type": "integer", "minimum": 64 },
          "description": "Available size variants"
        }
      },
      "additionalProperties": false
    },

    "generationConfig": {
      "type": "object",
      "required": ["baseHeight", "amplitude", "frequency", "layers"],
      "properties": {
        "baseHeight": { "$ref": "#/$defs/varianceValue" },
        "amplitude": { "$ref": "#/$defs/varianceValue" },
        "frequency": { "$ref": "#/$defs/varianceValue" },
        "layers": {
          "type": "array",
          "items": { "$ref": "#/$defs/materialLayer" },
          "minItems": 1,
          "description": "Material layers ordered by maxHeight ascending"
        }
      },
      "additionalProperties": false
    },

    "spawnConfig": {
      "type": "object",
      "required": ["count", "minSpacing", "fallbackSpawns"],
      "properties": {
        "count": { "type": "integer", "minimum": 1, "maximum": 10 },
        "minSpacing": { "type": "number", "minimum": 10, "description": "Minimum spacing between spawn points (studs)" },
        "preferOutdoor": { "type": "boolean", "default": true },
        "heightOffset": { "type": "number", "default": 3, "description": "Height offset above ground (studs)" },
        "avoidCenter": { "type": "boolean", "default": false },
        "fallbackSpawns": {
          "type": "array",
          "items": { "$ref": "#/$defs/vector3" },
          "description": "Fallback positions if dynamic spawn finding fails"
        }
      },
      "additionalProperties": false
    },

    "objectSpawnConfig": {
      "type": "object",
      "required": ["count", "minSpacing"],
      "properties": {
        "count": { "type": "integer", "minimum": 1, "maximum": 20 },
        "minSpacing": { "type": "number", "minimum": 5, "description": "Minimum spacing between object spawns (studs)" },
        "heightOffset": { "type": "number", "default": 2, "description": "Height offset above ground (studs)" }
      },
      "additionalProperties": false
    },

    "terrainFocusView": {
      "type": "object",
      "description": "Camera positioning for focus_camera tool when viewing terrain",
      "required": ["heightAboveGround", "distance", "offset"],
      "properties": {
        "heightAboveGround": {
          "type": "number",
          "description": "Camera height above terrain ground (studs)",
          "minimum": 10,
          "maximum": 500
        },
        "distance": {
          "type": "number",
          "description": "Camera distance from target (studs)",
          "minimum": 10,
          "maximum": 500
        },
        "offset": {
          "type": "object",
          "description": "Camera offset from target for lookAt calculation (studs)",
          "required": ["x", "y", "z"],
          "properties": {
            "x": { "type": "number", "description": "Horizontal offset (studs)" },
            "y": { "type": "number", "description": "Vertical offset (studs)" },
            "z": { "type": "number", "description": "Depth offset (studs)" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "postProcessStep": {
      "type": "object",
      "required": ["tool", "params"],
      "properties": {
        "tool": {
          "type": "string",
          "enum": ["terrain_smooth", "terrain_fill_block", "terrain_fill_ball", "terrain_fill_cylinder", "terrain_fill_wedge", "terrain_clear", "terrain_replace_material"]
        },
        "params": {
          "type": "object"
        }
      },
      "additionalProperties": false
    },

    "customization": {
      "type": "object",
      "properties": {
        "scaleFactor": {
          "type": "array",
          "items": { "type": "number", "minimum": 0.1, "maximum": 10 },
          "description": "Available scale multipliers"
        },
        "materialSwaps": {
          "type": "object",
          "description": "Material replacement options keyed by original material",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      },
      "additionalProperties": false
    }
  },

  "validation": {
    "fallbackSpawnsCountMustMatchSpawnCount": "spawnConfig.fallbackSpawns.length >= spawnConfig.count",
    "layersMustBeOrderedByMaxHeight": "generation.layers sorted ascending by maxHeight",
    "boundsMinLessThanMax": "bounds.min < bounds.max for all axes"
  }
}
